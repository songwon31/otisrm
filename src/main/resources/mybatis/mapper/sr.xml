<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.finalteam5.otisrm.dao.SrDao">
	<select id="countSr" resultType="int">
		count * from sr
	</select>
	
	<!-- 메인 테이블 구성 -->
	<select id="selectSrListForDeveloperHomeBoardByUsrIdAndStts" parameterType="map" resultType="com.finalteam5.otisrm.dto.sr.SrForDeveloperHomeBoard">
		SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
		FROM usr u1
		JOIN sr_trnsf_plan srt ON u1.usr_no = srt.usr_no
		JOIN sr ON srt.sr_no = sr.sr_no
		JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
		JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
		JOIN sys ON srr.sys_no = sys.sys_no
		JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
		JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
		<if test='srPrgrsSttsNo == null'>
			WHERE u1.usr_id = #{usrId}
		</if>
		<if test='srPrgrsSttsNo != null'>
			WHERE u1.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = #{srPrgrsSttsNo}
		</if>
		UNION
		SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
		FROM usr u1
		JOIN sr_trnsf_plan srt ON u1.usr_no = srt.usr_no
		JOIN sr ON srt.sr_no = sr.sr_no
		JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
		JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
		JOIN sys ON srr.sys_no = sys.sys_no
		JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
		JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
		JOIN sr_prgrs srpr ON srt.sr_no = srpr.sr_no
		JOIN usr u3 ON srpr.usr_no = u3.usr_no
		<if test='srPrgrsSttsNo == null'>
			WHERE u3.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = srpr.sr_prgrs_stts_no
		</if>
		<if test='srPrgrsSttsNo != null'>
			WHERE u3.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = srpr.sr_prgrs_stts_no AND srt.sr_prgrs_stts_no = #{srPrgrsSttsNo}
		</if>
		<if test='srPrgrsSttsNo == null || srPrgrsSttsNo.equals("RQST")'>
			UNION
			SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
			FROM usr u1
			JOIN sr_trnsf_plan srt ON u1.inst_no = srt.inst_no
			JOIN sr ON srt.sr_no = sr.sr_no
			JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
			JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
			JOIN sys ON srr.sys_no = sys.sys_no
			JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
			JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
			WHERE u1.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = 'RQST'
		</if>
		ORDER BY sr_no
	</select>
	
	<select id="selectSrListForDeveloperHomeBoardByUsrIdAndSttsAndPager" parameterType="map" resultType="com.finalteam5.otisrm.dto.sr.SrForDeveloperHomeBoard">
		SELECT rnum, sr_no, sys_nm, sr_task_nm, sr_ttl, usr_nm, sr_cmptn_prnmnt_dt, sr_trgt_cmptn_dt, sr_prgrs_stts_nm
		FROM(
			SELECT rownum as rnum, sr_no, sys_nm, sr_task_nm, sr_ttl, usr_nm, sr_cmptn_prnmnt_dt, sr_trgt_cmptn_dt, sr_prgrs_stts_nm
			FROM (	
				SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
				FROM usr u1
				JOIN sr_trnsf_plan srt ON u1.usr_no = srt.usr_no
				JOIN sr ON srt.sr_no = sr.sr_no
				JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
				JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
				JOIN sys ON srr.sys_no = sys.sys_no
				JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
				JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
				<if test='srPrgrsSttsNo == null'>
					WHERE u1.usr_id = #{usrId}
				</if>
				<if test='srPrgrsSttsNo != null'>
					WHERE u1.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = #{srPrgrsSttsNo}
				</if>
				UNION
				SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
				FROM usr u1
				JOIN sr_trnsf_plan srt ON u1.usr_no = srt.usr_no
				JOIN sr ON srt.sr_no = sr.sr_no
				JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
				JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
				JOIN sys ON srr.sys_no = sys.sys_no
				JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
				JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
				JOIN sr_prgrs srpr ON srt.sr_no = srpr.sr_no
				JOIN usr u3 ON srpr.usr_no = u3.usr_no
				<if test='srPrgrsSttsNo == null'>
					WHERE u3.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = srpr.sr_prgrs_stts_no
				</if>
				<if test='srPrgrsSttsNo != null'>
					WHERE u3.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = srpr.sr_prgrs_stts_no AND srt.sr_prgrs_stts_no = #{srPrgrsSttsNo}
				</if>
				<if test='srPrgrsSttsNo == null || srPrgrsSttsNo.equals("RQST")'>
					UNION
					SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
					FROM usr u1
					JOIN sr_trnsf_plan srt ON u1.inst_no = srt.inst_no
					JOIN sr ON srt.sr_no = sr.sr_no
					JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
					JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
					JOIN sys ON srr.sys_no = sys.sys_no
					JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
					JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
					WHERE u1.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = 'RQST'
				</if>
				ORDER BY sr_no
			)
		<![CDATA[
			WHERE rownum <= #{pager.endRowNo}
		)
		WHERE rnum >= #{pager.startRowNo}
		]]>
	</select>
	
	<select id="selectSrForDeveloperHomeBoardListByUsrId" parameterType="String" resultType="com.finalteam5.otisrm.dto.sr.SrForDeveloperHomeBoard">
		SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
		FROM usr u1
		JOIN sr_trnsf_plan srt ON u1.usr_no = srt.usr_no
		JOIN sr ON srt.sr_no = sr.sr_no
		JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
		JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
		JOIN sys ON srr.sys_no = sys.sys_no
		JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
		JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
		WHERE u1.usr_id = #{usrId}
		UNION
		SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
		FROM usr u1
		JOIN sr_trnsf_plan srt ON u1.usr_no = srt.usr_no
		JOIN sr ON srt.sr_no = sr.sr_no
		JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
		JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
		JOIN sys ON srr.sys_no = sys.sys_no
		JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
		JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
		JOIN sr_prgrs srpr ON srt.sr_no = srpr.sr_no
		JOIN usr u3 ON srpr.usr_no = u3.usr_no
		WHERE u3.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = srpr.sr_prgrs_stts_no
		UNION
		SELECT sr.sr_no, sys.sys_nm, srtk.sr_task_nm, srr.sr_ttl, u2.usr_nm, sr.sr_cmptn_prnmnt_dt, srt.sr_trgt_cmptn_dt, srp.sr_prgrs_stts_nm
		FROM usr u1
		JOIN sr_trnsf_plan srt ON u1.inst_no = srt.inst_no
		JOIN sr ON srt.sr_no = sr.sr_no
		JOIN usr u2 ON sr.pic_usr_no = u2.usr_no
		JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
		JOIN sys ON srr.sys_no = sys.sys_no
		JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
		JOIN sr_prgrs_stts srp ON srt.sr_prgrs_stts_no = srp.sr_prgrs_stts_no
		WHERE u1.usr_id = #{usrId} AND srt.sr_prgrs_stts_no = 'RQST'
		ORDER BY sr_no
	</select>
	
	
	
	<select id="selectSrTrnsfInfoForDeveloperHomeBySrNo" parameterType="String" resultType="com.finalteam5.otisrm.dto.sr.SrTrnsfInfoForDeveloperHome">
		SELECT srd.sr_dmnd_nm, srk.sr_task_nm, inst.inst_nm, dept.dept_nm, usr.usr_nm, srt.sr_trgt_bgng_dt, srt.sr_trgt_cmptn_dt, srt.sr_trnsf_note
		FROM sr_trnsf_plan srt
		JOIN sr ON srt.sr_no = sr.sr_no
		JOIN usr ON srt.usr_no = usr.usr_no
		JOIN sr_dmnd_clsf srd ON srt.sr_dmnd_no = srd.sr_dmnd_no
		JOIN sr_task_clsf srk ON sr.sr_task_no = srk.sr_task_no
		JOIN inst ON srt.inst_no = inst.inst_no
		JOIN dept ON srt.dept_no = dept.dept_no
		WHERE srt.sr_no = #{srNo}
	</select>
	
	<select id="selectSrPrgrsForDeveloperHomeList" parameterType="String" resultType="com.finalteam5.otisrm.dto.sr.SrPrgrsForDeveloperHome">
		SELECT srps.sr_prgrs_stts_nm, srp.sr_prgrs_bgng_dt, srp.sr_prgrs_cmptn_dt, srp.sr_prgrs, usr.usr_no, usr.usr_nm, role.role_nm
		FROM sr_prgrs srp
		JOIN sr_prgrs_stts srps ON srp.sr_prgrs_stts_no = srps.sr_prgrs_stts_no
		JOIN usr ON srp.usr_no = usr.usr_no
		JOIN role ON usr.role_no = role.role_no
		WHERE srp.sr_no = #{srNo}
		ORDER BY srps.sr_prgrs_stts_seq asc
	</select>
	
	<select id="selectSrRequestDetailForDeveloperHome" parameterType="String" resultType="com.finalteam5.otisrm.dto.sr.SrRequestDetailForDeveloperHome">
		SELECT sr.sr_no, srr.sr_rqst_no, sys.sys_nm, srt.sr_task_nm, srr.sr_ttl, srr.sr_prps, dept.dept_nm, usr.usr_nm,
			srr.sr_rqst_reg_dt, sr.sr_cmptn_prnmnt_dt, inst.inst_nm, sr.sr_trnsf_dt, srr.sr_conts, sr.sr_dvl_conts
		FROM sr
		JOIN sr_rqst srr ON sr.sr_rqst_no = srr.sr_rqst_no
		JOIN inst on sr.sr_trnsf_inst_no = inst.inst_no
		JOIN usr ON sr.pic_usr_no = usr.usr_no
		JOIN dept ON usr.dept_no = dept.dept_no
		JOIN sys ON srr.sys_no = sys.sys_no
		JOIN sr_task_clsf srt ON sr.sr_task_no = srt.sr_task_no
		WHERE sr.sr_no = #{srNo}
	</select>
	
	<select id="selectDmndList" resultType="com.finalteam5.otisrm.dto.SrDmndClsf">
		SELECT DISTINCT sr_dmnd_no, sr_dmnd_nm
		FROM sr_dmnd_clsf
	</select>
	
	<select id="selectTaskList" resultType="com.finalteam5.otisrm.dto.SrTaskClsf">
		SELECT sr_task_no, sr_task_nm
		FROM sr_task_clsf
	</select>
	
	<select id="selectDeptListByUsrId" parameterType="String" resultType="com.finalteam5.otisrm.dto.usr.Dept">
		SELECT dept.dept_no, dept.dept_nm
		FROM usr
		JOIN dept ON usr.inst_no = dept.inst_no
		WHERE usr.usr_id = #{usrId}
	</select>
	
	<select id="selectUsrListByUsrId" parameterType="String" resultType="com.finalteam5.otisrm.dto.usr.Usr">
		SELECT usr2.usr_no, usr2.usr_nm
		FROM usr
		JOIN inst ON usr.inst_no = inst.inst_no
		JOIN usr usr2 ON inst.inst_no = usr2.inst_no
		WHERE usr.usr_id = #{usrId}
	</select>
	
	<!-- SR계획정보 모달 구성 -->
	<select id="getCurrentSrTrnsfPlanInfo" parameterType="String" resultType="com.finalteam5.otisrm.dto.sr.SrTrnsfPlanModalCompose">
		SELECT srd.sr_dmnd_nm, srtk.sr_task_nm, dept.dept_nm, usr.usr_nm, srt.sr_trgt_bgng_dt, srt.sr_trgt_cmptn_dt, srt.sr_trnsf_note
		FROM sr_trnsf_plan srt
        JOIN sr ON srt.sr_no = sr.sr_no
		JOIN sr_dmnd_clsf srd ON srt.sr_dmnd_no = srd.sr_dmnd_no
		JOIN sr_task_clsf srtk ON sr.sr_task_no = srtk.sr_task_no
		JOIN dept ON srt.dept_no = dept.dept_no
		JOIN usr ON srt.usr_no = usr.usr_no
		WHERE srt.sr_no = #{srNo}
	</select>
	
	<!-- 담당자 선택 모달 구성 -->
	<select id="countSrTrnsfFindPicModalCompose" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM usr
		JOIN inst ON usr.inst_no = inst.inst_no
		JOIN usr usr2 ON inst.inst_no = usr2.inst_no
		JOIN dept ON usr2.dept_no = dept.dept_no
		JOIN role ON usr2.role_no = role.role_no
		JOIN ibps ON usr2.ibps_no = ibps.ibps_no
		WHERE usr.usr_id = #{usrId}
		<if test='deptNo != null'>AND dept.dept_no = #{deptNo}</if>
		<if test='usrNm != null'>AND usr2.usr_nm = #{usrNm}</if>
		ORDER BY role.role_seq desc
	</select>
	
	<select id="selectSrTrnsfFindPicModalCompose" parameterType="map" resultType="com.finalteam5.otisrm.dto.sr.SrTrnsfFindPicModalUsrInfo">
		SELECT rnum, dept_nm, role_nm, ibps_nm, usr_nm
		FROM(
			SELECT rownum as rnum, dept_nm, role_nm, ibps_nm, usr_nm
			FROM (
				SELECT dept.dept_nm, role.role_nm, ibps.ibps_nm, usr2.usr_nm
				FROM usr
				JOIN inst ON usr.inst_no = inst.inst_no
				JOIN usr usr2 ON inst.inst_no = usr2.inst_no
				JOIN dept ON usr2.dept_no = dept.dept_no
				JOIN role ON usr2.role_no = role.role_no
				JOIN ibps ON usr2.ibps_no = ibps.ibps_no
				WHERE usr.usr_id = #{usrId}
				<if test='deptNo != null'>AND dept.dept_no = #{deptNo}</if>
				<if test='usrNm != null'>AND usr2.usr_nm = #{usrNm}</if>
				ORDER BY role.role_seq desc
			)
		<![CDATA[
			WHERE rownum <= #{pager.endRowNo}
		)
		WHERE rnum >= #{pager.startRowNo}
		]]>
	</select>
	
	<!-- sr이관 계획 수정 -->
	<select id="selectDeptNoByDeptNmAndSrNo" parameterType="map" resultType="String">
		SELECT dept_no
		FROM sr
		JOIN dept ON dept.inst_no = sr_trnsf_inst_no
		WHERE sr.sr_no = #{srNo} AND dept.dept_nm = #{deptNm}
	</select>
	
	<select id="selectUsrNoByUsrNm" parameterType="String" resultType="String">
		SELECT usr_no
		FROM usr
		WHERE usr_nm = #{usrNm}
	</select>
	
	<update id="updateSrTrnsfPlan" parameterType="com.finalteam5.otisrm.dto.SrTrnsfPlan">
		UPDATE sr_trnsf_plan
		SET dept_no = #{deptNo},
			usr_no = #{usrNo},
			sr_trgt_bgng_dt = #{srTrgtBgngDt},
			sr_trgt_cmptn_dt = #{srTrgtCmptnDt},
			sr_trnsf_note = #{srTrnsfNote, jdbcType=VARCHAR}
		WHERE sr_no = #{srNo}
	</update>
</mapper>