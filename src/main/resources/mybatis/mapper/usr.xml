<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.finalteam5.otisrm.dao.UsrDao">
	<!-- 회원가입 폼 -->
	<!-- 기관(inst) 목록 불러오기 -->
	<select id="selectInstList"  resultType="Inst">
	       select * from inst order by inst_no desc		 
    </select>
	<!--가입 권한(UserAuthrt) 목록 불러오기 -->
	<select id="selectUsrAuthrtList"  resultType="UsrAuthrt">
	        select * from usr_authrt		 
    </select>
	<!--기관에 해당하는 개발부서 목록 불러오기 -->
	<select id="selectDeptListByInstNo" parameterType="String" resultType="Dept">
	       select * from dept
	       <if test="instNo != null">
	       		where inst_no = #{instNo}
	       </if>
    </select>
	<!--기관에 해당하는 직위 목록 불러오기 -->
	<select id="selectIbpsListByInstNo" parameterType="String" resultType="Ibps">
	       select * from ibps
	       <if test="instNo != null">
	       		where inst_no = #{instNo}
	       </if>
    </select>
	<!--기관에 해당하는 역할 목록 불러오기 -->
	<select id="selectRoleListByInstNo" parameterType="String" resultType="Role">
	       select * from role
	       <if test="instNo != null">
	       		where inst_no = #{instNo}
	       </if>
    </select>
	<!--아이디 중복검사 -->
	<select id="selectNumOfOverlapUsrId" parameterType="String" resultType="int">
	       select count(*) from usr where usr_id = #{usrId}
    </select>
    <!-- 회원가입 폼 제출  -->
    <insert id="insertUsr" parameterType="Usr">
	    <![CDATA[
	     DECLARE
	        l_generated_usr_no VARCHAR2(6);
	     BEGIN
	     	l_generated_usr_no := 'US' || LPAD(TO_CHAR(FLOOR(DBMS_RANDOM.VALUE(1000, 10000))), 4, '0');
		    INSERT INTO usr(
		        USR_NO, USR_ID, USR_PSWD, USR_NM, USR_RRNO, USR_TELNO, USR_EML, INST_NO,
		        DEPT_NO, IBPS_NO, ROLE_NO, USR_AUTHRT_NO, USR_STTS_NO, LGN_FAIL_CNT,
		        RPRS_IMG, USR_JOIN_DT, USR_WHDWL_DT
		    ) values(
		       l_generated_usr_no, #{usrId}, #{usrPswd}, #{usrNm},#{usrRrno},#{usrTelno},#{usrEml},#{instNo}, 
		        #{deptNo}, #{ibpsNo}, #{roleNo}, #{usrAuthrtNo},'PENDING', 0, null, sysdate, null
		    );
		 END;
 		]]>
	</insert>
    
    <!-- 로그인 폼 -->
	<select id="selectByUsrId" parameterType="String" resultType="Login">
		select u.usr_no, u.usr_nm, u.usr_authrt_no, u.usr_id, u.usr_pswd, u.usr_stts_no, u.rprs_img, a.usr_authrt_nm
		from usr u
		join usr_authrt a on u.usr_authrt_no = a.usr_authrt_no
		where usr_Id = #{usrId}		 
    </select>
    <!--
      	로그인 틀린 횟수 업데이트
	<update id="updateLgnFailCnt" parameterType="String">
	    UPDATE users
	    SET lgn_fail_cnt = lgn_fail_cnt + 1
	    WHERE usr_id = #{usr_id}
	</update>
	
	<update id="resetLgnFailCnt" parameterType="String">
	    UPDATE users
	    SET login_failure_count = 0
	    WHERE usr_id = #{usr_id}
	</update>
	 -->
    
    <!-- 작성자: 송원석 /사용자 상태(UsrStts) 목록 불러오기 -->
    <select id="selectUsrSttsList" resultType="UsrStts">
	 	select * from usr_stts
    </select>
    
    <!-- 작성자: 송원석 , 성유짱/usrId를 통해 사용자 테이블 정보 불러오기 -->
    <select id="selectUsrDetailsByUsrId" parameterType="String" resultType="Usr">
    	select u.usr_no, u.usr_id, u.usr_pswd, u.usr_nm, u.usr_rrno, u.usr_telno, u.usr_eml,
    		u.inst_no, u.dept_no, u.ibps_no, u.role_no, u.usr_authrt_no, u.usr_stts_no, 
    		u.lgn_fail_cnt, u.usr_join_dt, u.usr_whdwl_dt, a.usr_authrt_nm, i.inst_nm
    	from usr u
    	join usr_authrt a on u.usr_authrt_no = a.usr_authrt_no
    	join inst i on u.inst_no = i.inst_no
		where usr_Id = #{usrId}		 
    </select>
	
</mapper>