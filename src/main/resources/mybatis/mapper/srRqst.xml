<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.finalteam5.otisrm.dao.SrRqstDao">
	<!-- 작성자: 성유진  -->
	
	<!-- sr요청등록 폼 -->
	<!-- 부서번호에 해당하는 관련 시스템 목록 불러오기 -->
	<select id="selectSysByDeptNo" parameterType="String" resultType="Sys">
		select * from sys where dept_no = #{deptNo}
	</select>
	
	<!-- sr요청 등록하기 -->
	<!-- PK는 트리거를 사용해서 null로 지정할  경우 자동으로 정해진 포멧으로 삽입됨 -->
	<insert id="insertSrRqst" parameterType="SrRqstSubmit">
		insert into sr_rqst(
		    sr_rqst_no, sr_ttl, sr_prps, sr_reqstr_no, sr_conts, 
		    sr_rqst_reg_dt, sr_rqst_mdfcn_dt, sr_rqst_stts_no, sys_no, 
		    sr_rqst_emrg_yn, sr_rqst_rvw_rsn, sr_rqst_vld_yn
		) values(
	       null, #{srTtl, jdbcType=VARCHAR}, #{srPrps, jdbcType=VARCHAR}, 
	       #{srReqstrNo , jdbcType=VARCHAR}, #{srConts, jdbcType=VARCHAR},
	       sysdate, #{srRqstMdfcnDt, jdbcType=DATE}, 'RQST', #{sysNo, jdbcType=VARCHAR}, 
	       #{srRqstEmrgYn, jdbcType=VARCHAR}, #{srRqstRvwRsn, jdbcType=VARCHAR}, 'N'
    	)
	</insert>
	
	<!-- 최근 삽입한 sr요청 불러오기(첨부파일 등록을 위함) -->
	<select id="selectAddSrRqstPk" resultType="String">
		select sr_rqst_no from (
		  select * from sr_rqst order by sr_rqst_reg_dt desc
		) where rownum = 1
	</select>
	
	<!-- sr요청 등록 첨부파일 업로드 -->
	<!-- PK는 트리거를 사용해서 null로 지정할  경우 자동으로 정해진 포멧으로 삽입됨 -->
	<insert id="insertSrRqstAtch" parameterType="SrRqstAtch">
	    insert into sr_rqst_atch(
	        sr_rqst_atch_no, sr_rqst_no, sr_rqst_atch_nm, sr_rqst_atch_mime_type,
	        sr_rqst_atch_data, sr_rqst_atch_size
	    ) values(
	        null, #{srRqstNo, jdbcType=VARCHAR}, #{srRqstAtchNm, jdbcType=VARCHAR},
	        #{srRqstAtchMimeType, jdbcType=VARCHAR}, #{srRqstAtchData, jdbcType=BLOB},
	        #{srRqstAtchSize, jdbcType=NUMERIC}
	    )
	</insert>
	
	<!-- sr요청 불러오기 -->
	<select id="selectSrRqstListByPage" parameterType="Map" resultType="SrRqst">
		select rnum, sr_rqst_no, sr_ttl, sr_reqstr_no, sr_rqst_reg_dt, sr_rqst_mdfcn_dt, dept_no, dept_nm, sr_rqst_stts_seq,
		sr_rqst_stts_no, sys_no, sr_rqst_emrg_yn, sr_rqst_rvw_rsn, sr_rqst_vld_yn, sys_nm, usr_nm, inst_nm, sr_rqst_stts_nm  
		from (
		    select rownum as rnum, sr_rqst_no, sr_ttl, sr_reqstr_no, sr_rqst_reg_dt, sr_rqst_mdfcn_dt, dept_no, dept_nm, sr_rqst_stts_seq,
		    sr_rqst_stts_no, sys_no, sr_rqst_emrg_yn, sr_rqst_rvw_rsn, sr_rqst_vld_yn, sys_nm, usr_nm, inst_nm, sr_rqst_stts_nm  
		    from(
		        select r.sr_rqst_no, r.sr_ttl, sr_reqstr_no, r.sr_rqst_reg_dt, r.sr_rqst_mdfcn_dt, r.sr_rqst_stts_no,
		        q.sr_rqst_stts_seq, r.sys_no, r.sr_rqst_emrg_yn, r.sr_rqst_rvw_rsn, r.sr_rqst_vld_yn, s.sys_nm, u.usr_nm, u.inst_no, i.inst_nm, q.sr_rqst_stts_nm,
		        d.dept_no, d.dept_nm 
		        from sr_rqst r
		        join sys s on s.sys_no = r.sys_no 
		        join usr u on u.usr_no = r.sr_reqstr_no
		        join dept d on d.dept_no = u.dept_no 
		        join inst i on i.inst_no = u.inst_no
		        join sr_rqst_stts q on q.sr_rqst_stts_no = r.sr_rqst_stts_no
		        <if test="status != null and status != '' or usr != null and usr != '' or keyword != null and keyword != ''">
				  <where>
				    <if test="status != null and status != ''">
				      r.sr_rqst_stts_no = #{status, jdbcType=VARCHAR}
				    </if>
				    <if test="status != null and status != '' and (usr != null and usr != '' or keyword != null and keyword != '')">
				      AND
				    </if>
				    <if test="usr != null and usr != ''">
				      sr_reqstr_no = #{usr, jdbcType=VARCHAR}
				    </if>
				    <if test="keyword != null and keyword != ''">
				      REGEXP_REPLACE(LOWER(REPLACE(pg_name, ' ', '')), '[[:punct:]]', '') LIKE '%' || REGEXP_REPLACE(LOWER(REPLACE(#{keyword}, ' ', '')), '[[:punct:]]', '') || '%'
				    </if>
				  </where>
				</if>
			    order by sr_rqst_reg_dt desc
		    )
		<![CDATA[
			    where rownum <= #{endRowNo}
			    
			 )
			 where rnum >= #{startRowNo}
		]]>
	</select>
	
	<!-- 전체 sr요청 수(페이징을 위함) -->
	<select id="countSrRqst" parameterType="Map" resultType="int">
		select count(*) from sr_rqst
		<if test="status != null and status != '' or usr != null and usr != ''">
		  <where>
		    <if test="status != null and status != ''">
		       sr_rqst_stts_no = #{status, jdbcType=VARCHAR}
		    </if>
		    <if test="status != null and status != '' and usr != null and usr != ''">
		      AND
		    </if>
		    <if test="usr != null and usr != ''">
		      sr_reqstr_no = #{usr, jdbcType=VARCHAR}
		    </if>
		  </where>
		</if>
	</select>

	<!-- sr요청 상세 불러오기-->
	<select id="selectSrRqstBySrRqstNo" parameterType="String" resultType="SrRqst">
		select r.*, s.sys_nm, u.usr_nm, u.inst_no, i.inst_nm, q.sr_rqst_stts_nm
		from sr_rqst r
		join sys s on s.sys_no = r.sys_no 
		join usr u on u.usr_no = r.sr_reqstr_no
		join inst i on i.inst_no = u.inst_no
		join sr_rqst_stts q on q.sr_rqst_stts_no = r.sr_rqst_stts_no	
		where r.sr_rqst_no=#{srRqstNo}	
	</select>
	
	<!-- sr요청 상세에 해당하는 첨부파일 불러오기 -->
	<select id="selectSrRqstAtchBySrRqstNo" parameterType="String" resultType="SrRqstAtch" >
		select * from sr_rqst_atch where sr_rqst_no = #{srRqstNo}
	</select>
	
	<!-- sr요청첨부파일 번호에 해당하는 첨부파일 불러오기 -->
	<select id="selectSrRqstAtchBySrRqstAtchNo" parameterType="String" resultType="SrRqstAtch">
		select * from sr_rqst_atch where sr_rqst_atch_no = #{srRqstAtchNo}
	</select>
	
	<!-- 등록한 sr요청 수정 -->
	<update id="updateSrRqst" parameterType="SrRqstSubmit">
		update sr_rqst set sr_ttl=#{srTtl, jdbcType=VARCHAR}, sr_prps=#{srPrps, jdbcType=VARCHAR}, sr_rqst_emrg_yn=#{srRqstEmrgYn, jdbcType=VARCHAR},
		sr_conts= #{srConts, jdbcType=VARCHAR}, sr_rqst_mdfcn_dt = sysdate
		where sr_rqst_stts_no = 'RQST' 
		and sr_rqst_no= #{srRqstNo, jdbcType=VARCHAR}
	</update>
	
	<!-- sr요청 메뉴 검색창 -->
	<!-- 관련 시스템 전체 목록 불러오기 -->
	
	
	
	<!-- 작성자: 이현주  -->
	<!-- 검토자 홈 요청목록 불러오기 -->
	<select id="selectSrRqstForReviewerHomeBoardListByPage" parameterType="Map" resultType="com.finalteam5.otisrm.dto.srRequest.SrRqstForReviewerHomeBoard">
		<![CDATA[
		select rnum, sr_rqst_no, sr_ttl, sys_nm, usr_nm, inst_nm, sr_rqst_stts_nm, sr_rqst_reg_dt, sr_cmptn_prnmnt_dt
		from (
		    select rownum as rnum, sr_rqst_no, sr_ttl, sys_nm, usr_nm, inst_nm, sr_rqst_stts_nm, sr_rqst_reg_dt, sr_cmptn_prnmnt_dt
		    from(
		        select r.sr_rqst_no, r.sr_ttl, s.sys_nm, u.usr_nm, i.inst_nm, rs.sr_rqst_stts_nm, r.sr_rqst_reg_dt, sr.sr_cmptn_prnmnt_dt
		        from sr_rqst r
		        join sys s on s.sys_no = r.sys_no 
		        join usr u on u.usr_no = r.sr_reqstr_no
		        join inst i on i.inst_no = u.inst_no
		        join sr_rqst_stts rs on rs.sr_rqst_stts_no = r.sr_rqst_stts_no
		        left join sr on sr.sr_rqst_no = r.sr_rqst_no
		        where #{srRqstSttNm} = '전체' or rs.sr_rqst_stts_nm = #{srRqstSttNm}
		        order by sr_rqst_no desc
		        )
			where rownum <= #{endRowNo}
		)
		where rnum >= #{startRowNo}	
		]]>
	</select>
	
	<!-- 검토자 상세모달로 SR정보 가져오기 -->
	<select id="selectSrRqstForReviewerModal" parameterType="String" resultType="com.finalteam5.otisrm.dto.srRequest.SrRqstForReviewerModal">
		select 
		    r.sr_rqst_no as sr_rqst_no,
		    reqstr.usr_nm as sr_reqstr_nm,
		    reqstr_inst.inst_nm as reqstr_inst_nm,
		    r.sr_rqst_reg_dt,
		    sys.sys_nm,
		    r.sr_ttl,
		    r.sr_conts,
		    r.sr_rqst_rvw_rsn,
		    pic.usr_nm as sr_pic_usr_nm,
		    dept.dept_nm,
		    sr.sr_trnsf_yn,
		    trnsf_inst.inst_nm as sr_trnsf_inst_nm,
		    sr.sr_req_bgt,
		    sr.sr_cmptn_prnmnt_dt,
		    sr.sr_dvl_conts
		from sr_rqst r
		join sys on r.sys_no = sys.sys_no
		join usr reqstr on r.sr_reqstr_no = reqstr.usr_no
		join inst reqstr_inst on reqstr.inst_no = reqstr_inst.inst_no
		left join sr on r.sr_rqst_no = sr.sr_rqst_no
		left join usr pic on pic.usr_no = sr.pic_usr_no 
		left join inst trnsf_inst on trnsf_inst.inst_no = sr.sr_trnsf_inst_no
		left join dept on dept.dept_no =pic.dept_no
		where r.sr_rqst_no = #{selectedSrRqstNo}
	</select>
	
	<!-- 상태별 요청수 가져오기 -->
	<select id="countSrRqstBySttsNm" parameterType="String" resultType="int">
		select count(*)
		from sr_rqst r
		join sr_rqst_stts rs on rs.sr_rqst_stts_no = r.sr_rqst_stts_no
		where #{srRqstSttNm} = '전체' or rs.sr_rqst_stts_nm = #{srRqstSttNm}
	</select>
	
	<!-- 전체 시스템명 가져오기 -->
	<select id="selectTotalSysNm" resultType="String">
		select distinct sys_nm from sys
	</select>
</mapper>